/*! client 2020-04-17 */

let url,fullName,productId;const STARTING_BALANCE=100;$(document).ready(function(){function t(){let t=document.querySelectorAll(".btn-category");for(let e=0;e<t.length;e++)$("#"+t[e].id).removeClass("btn-secondary").addClass("btn-outline-secondary")}function e(){$("#filterSelect").val("featured")}function s(t){var e=[];if(sessionStorage.getItem("userID"))$.ajax({url:`${url}/users/u=${sessionStorage.getItem("userID")}`,type:"GET",dataType:"json",success:function(s){e=s.watchlist,document.getElementById("productCards").innerHTML="";var n=!1;t:for(let s=0;s<t.length;s++)if("listed"===t[s].status){let o=`<div class="product-link position-relative card p-0 col-lg-3 col-sm-12 col-md-6" id="${t[s]._id}">\n\t\t\t\t\t\t\t<img class="card-img-top p-4 bg-light" src="${t[s].image}" alt="Image">`;if(sessionStorage.username&&sessionStorage.getItem("userID")!=t[s].sellerId){for(let a=0;a<e.length;a++){if(e[a]==t[s]._id){o+=`<div class="btn-watchlist-card" title="Remove from watchlist">-</div>\n\t\t\t\t\t\t\t\t\t\t<div class="card-body">\n\t\t\t\t\t\t\t\t\t\t<h3 class="card-title"> ${t[s].title}</h3>\n\t\t\t\t\t\t\t\t\t\t<h4 class="card-text">$${t[s].price}</h4>\n\t\t\t\t\t\t\t\t\t\t</div></div>`,document.getElementById("productCards").innerHTML+=o;continue t}n=!0}(n||0===e.length)&&(o+='<div class="btn-watchlist-card" title="Add to watchlist">+</div>')}o+=`<div class="card-body">\n\t\t\t\t\t\t\t<h3 class="card-title"> ${t[s].title}</h3>\n\t\t\t\t\t\t\t<h4 class="card-text">$${t[s].price}</h4>\n\t\t\t\t\t\t\t</div></div>`,document.getElementById("productCards").innerHTML+=o}l(),o(t)},error:function(t){alert("Failed to get buyer's details")}});else{document.getElementById("productCards").innerHTML=" ";for(var s=0;s<t.length;s++)if("listed"==t[s].status){let e=`<div class="product-link position-relative card p-0 col-lg-3 col-sm-12 col-md-6" id="${t[s]._id}">\n\t\t\t\t\t<img class="card-img-top p-4 bg-light" src="${t[s].image}" alt="Image">`;e+=`<div class="card-body">\n\t\t\t\t\t<h3 class="card-title"> ${t[s].title}</h3>\n\t\t\t\t\t<h4 class="card-text">$${t[s].price}</h4>\n\t\t\t\t\t</div></div>`,document.getElementById("productCards").innerHTML+=e}l()}}function o(t){$(".btn-watchlist-card").click(function(t){var e=$(this).text(),s=t.target.parentNode.attributes[1].value;t.stopPropagation(),"-"===e?$.ajax({url:`${url}/products/p=${s}`,type:"GET",dataType:"json",success:function(t){var e=t.sellerId;$.ajax({url:`${url}/users/u=${e}`,type:"GET",dataType:"json",success:function(e){$.ajax({url:`${url}/users/u=${sessionStorage.getItem("userID")}`,type:"GET",data:"json",success:function(e){e.watchlist;var o=s;$.ajax({url:`${url}/removeWatchlist/u=${sessionStorage.getItem("userID")}`,type:"PATCH",data:{watchlist:o},success:function(){swal({title:"Removed from watchlist",text:`Successfully removed ${t.title} from your watchlist`,icon:"success",button:"Got it",timer:2500}).then(function(){location.reload()})},error:function(t){alert("Failed to remove from watchlist")}})},error:function(t){alert("Failed to get buyer's details")}})},error:function(t){alert("Failed to get seller's details")}})},error:function(t){alert("Failed to get product details")}}):$.ajax({url:`${url}/products/p=${s}`,type:"GET",dataType:"json",success:function(t){var e=t.sellerId;$.ajax({url:`${url}/users/u=${e}`,type:"GET",dataType:"json",success:function(o){$.ajax({url:`${url}/users/u=${sessionStorage.getItem("userID")}`,type:"GET",data:"json",success:function(o){var n=o.watchlist,a=s;-1==n.indexOf(a)&&e!=sessionStorage.getItem("userID")&&$.ajax({url:`${url}/updateWatchlist/u=${sessionStorage.getItem("userID")}`,type:"PATCH",data:{watchlist:a},success:function(e){swal({title:"Added to watchlist",text:`Successfully added ${t.title} to your watchlist`,icon:"success",button:"Got it",timer:2500}).then(function(){location.reload()})},error:function(t){alert("failed to add product to watchlist")}})},error:function(t){alert("failed to add to watchlist")}})},error:function(){alert("Failded to get seller's details")}})},error:function(t){alert("Could not find product")}})})}function n(){$.ajax({url:`${url}/products`,type:"GET",dataType:"json",success:function(t){s(t)},error:function(t){console.log("can' show products")}})}function a(t){$("#productAddToWatchList").click(function(){$.ajax({url:`${url}/users/u=${sessionStorage.getItem("userID")}`,type:"GET",data:"json",success:function(e){var s=e.watchlist,o=t._id;t.sellerId;-1==s.indexOf(o)&&$.ajax({url:`${url}/updateWatchlist/u=${sessionStorage.getItem("userID")}`,type:"PATCH",data:{watchlist:o},success:function(e){swal({title:"Added to watchlist",text:`Successfully added ${t.title} to your watchlist`,icon:"success",button:"Got it",timer:2500}),document.getElementById("dynamicBtnContainer").innerHTML='<div class="col-lg-6 col-md-12">\n\t\t\t\t\t\t\t\t<button id="productPurchase" class="btn btn-outline-success btn-block">Buy Now</button>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<div class="col-lg-6 col-md-12">\n\t\t\t\t\t\t\t\t<button id="productRemoveFromWatchList" class="btn btn-outline-danger btn-block watchlist-btn">Remove from watchlist</button>\n\t\t\t\t\t\t\t\t</div>',a(t)},error:function(t){alert("failed to add product to watchlist")}})},error:function(t){alert("failed to add to watchlist")}})}),$("#productRemoveFromWatchList").click(function(){$.ajax({url:`${url}/users/u=${sessionStorage.getItem("userID")}`,type:"GET",data:"json",success:function(e){e.watchlist;var s=t._id;$.ajax({url:`${url}/removeWatchlist/u=${sessionStorage.getItem("userID")}`,type:"PATCH",data:{watchlist:s},success:function(){swal({title:"Removed from watchlist",text:`Successfully removed ${t.title} from your watchlist`,icon:"success",button:"Got it",timer:2500}),document.getElementById("dynamicBtnContainer").innerHTML='<div class="col-lg-6 col-md-12">\n\t\t\t\t\t\t\t<button id="productPurchase" class="btn btn-outline-success btn-block">Buy Now</button>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="col-lg-6 col-md-12">\n\t\t\t\t\t\t\t<button id="productAddToWatchList" class="btn btn-outline-primary btn-block watchlist-btn">Add to watchlist</button>\n\t\t\t\t\t\t\t</div>',a(t)},error:function(t){alert("Failed to remove from watchlist")}})},error:function(t){alert("Failed to get buyer's details")}})})}function i(t){$("#productPurchase").click(function(){swal({title:`Purchase ${t.title}`,text:`Are you sure you want to purchase ${t.title} for $${t.price}?`,buttons:{cancel:"Cancel",success:{text:"Purchase",value:"add"}}}).then(e=>{switch(e){case"add":$.ajax({url:`${url}/users/u=${sessionStorage.getItem("userID")}`,type:"GET",data:"json",success:function(e){e.balance>t.price?$.ajax({url:`${url}/productSold/p=${t._id}`,type:"PATCH",data:{buyerId:`${sessionStorage.getItem("userID")}`,status:"sold"},success:function(s){document.getElementById("questionForm").innerHTML='<div class="alert alert-danger col-12 text-center" role="alert">\n\t\t\t\t\t\t\t\t\t\tThis product has been sold so questions are closed</div>',document.getElementById("dynamicBtnContainer").innerHTML='<div class="alert alert-danger col-12 text-center" role="alert">This product has been sold</div>',$.ajax({url:`${url}/users/u=${t.sellerId}`,type:"GET",data:"json",success:function(s){var o=e.balance-t.price,n=s.balance+t.price;$.ajax({url:`${url}/products/p=${t._id}`,type:"GET",data:"json",success:function(t){c(t)},error:function(t){alert("Can't get product")}}),$.ajax({url:`${url}/updateBalance/u=${sessionStorage.getItem("userID")}`,type:"PATCH",data:{balance:o},success:function(){console.log("Buyer's balance has changed to "+e.balance)},error:function(t){console.log("Couldn't update buyer's balance")}}),$.ajax({url:`${url}/updateBalance/u=${t.sellerId}`,type:"PATCH",data:{balance:n},success:function(){console.log("Seller's balance has changed to "+s.balance)},error:function(t){console.log("Couldn't update seller's balance")}})},eorror:function(){alert("Failed to get seller's information")}})},error:function(t){alert("Unable to make purchase")}}):swal({title:"Insuficient funds",text:`Unable to purchase ${t.title} due to insufficient funds. Please add more credit to your account to be able to purchase this.`,icon:"error",button:"Got it!",timer:2500})},error:function(t){alert("Failed to get buyer's details")}}),swal({title:`${t.title} has been purchased`,text:`Successfully purchased ${t.title}, itemId #${t._id}`,icon:"success",button:"Got it",timer:2500})}})})}function r(t){let e=t.category.toLowerCase(),s=document.querySelectorAll(".btn-category");for(let t=0;t<s.length;t++){let o=s[t].id.slice(0,-6);e.includes(o)&&$("#"+s[t].id).removeClass("btn-outline-secondary").addClass("btn-secondary").siblings().removeClass("btn-secondary").addClass("btn-outline-secondary")}$.ajax({url:`${url}/users/u=${t.sellerId}`,type:"GET",dataType:"json",success:function(e){document.getElementById("productInformation").innerHTML=`<div class="d-flex justify-content-center align-items-center">\n\t\t\t\t<img src="${t.image}" class="img-fluid" alt="${t.title}"></div>\n\t\t\t\t<div class="product-description my-5">${t.description}</div>\n\t\t\t\t<div class="col-12" id="questionForm"></div>\n\t\t\t\t<div class="question-previous-questions col-12 mt-5">\n\t\t\t\t<h3 class="bg-light p-3">Questions and Answers</h3>\n\t\t\t\t<div class="col-12" id="qAndAPrintOut"></div></div>`;let s=`<h3>${t.title}</h3>\n\t\t\t\t<h4 class="small">Listing #: ${t._id}</h4>\n\t\t\t\t<h4 class="text-success font-weight-bold my-4">$${t.price}</h4>\n\t\t\t\t<div id="dynamicBtnContainer" class="row"></div>\n\t\t\t\t<div class="mt-3">\n\t\t\t\t<h5 class="mb-0">Seller:</h5>\n\t\t\t\t<h4 class="mb-0">${e.username}</h5>\n\t\t\t\t<h6 class="mb-2">${e.location}</h6>`;t.shipping.pickup&&t.shipping.deliver?s+='<p class="mb-0">Shipping: Pick up and delivery available</p></div>':t.shipping.pickup?s+='<p class="mb-0">Shipping: Pick up only</p></div>':t.shipping.deliver&&(s+='<p class="mb-0">Shipping: Delivery only</p></div>'),document.getElementById("productButtonContainer").innerHTML=s,c(t)}})}function l(){$(".product-link").click(function(){let t=this.id;$("#account").hide(),$("#productCards").hide(),$("#productPage").show(),$("#filterBar").hide(),$.ajax({url:`${url}/products/p=${t}`,type:"GET",dataType:"json",success:function(t){r(t)},error:function(t){console.log("failed")}})})}function c(e){let s=e.status,o=e._id;var l=e.sellerId;$.ajax({url:`${url}/users/u=${sessionStorage.getItem("userID")}`,type:"GET",data:"json",success:function(c){if("sold"==s)document.getElementById("questionForm").innerHTML='<div class="alert alert-danger col-12 text-center" role="alert">\n\t\t\t\t\tThis product has been sold so questions are closed</div>',document.getElementById("dynamicBtnContainer").innerHTML='<div class="alert alert-danger col-12 text-center" role="alert">This product has been sold</div>';else if(sessionStorage.username&&l==sessionStorage.getItem("userID"))document.getElementById("questionForm").innerHTML='<div class="question-form row mx-0 bg-light py-3 col-12 mb-5">\n\t\t\t\t\t<h3>Ask a Question</h3>\n\t\t\t\t\t<textarea class="form-control" id="newQuestion" rows="3"></textarea>\n\t\t\t\t\t<div class="col-12">\n\t\t\t\t\t<button type="button" id="submitQuestionBtn" class="btn btn-primary mt-3 float-right">Ask Question</button>\n\t\t\t\t\t</div></div>',document.getElementById("dynamicBtnContainer").innerHTML='<div class="alert alert-primary col-12 text-center" role="alert">This is your product</div>\n\t\t\t\t\t<div class="col-lg-6 col-md-12">\n\t\t\t\t\t<button id="editProduct" class="btn btn-outline-success btn-block" data-toggle="modal" data-target="#updateProductModal">Edit product</button>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="col-lg-6 col-md-12">\n\t\t\t\t\t<button id="deleteProduct" class="btn btn-outline-danger btn-block">Delete product</button>\n\t\t\t\t\t</div>',function(e){$("#editProduct").click(function(){$("#wrongImageEditAlert").hide(),$("#updateTitle").val(e.title),$("#updatePrice").val(e.price),$("#updateCategory").val(e.category),$("#updateDescription").val(e.description),$("#updateKeywords").val(e.keywords),$("#updateImage").val(e.image.slice(31)),$("#updateShipping-pick").prop("checked",e.shipping.pickup),$("#updateShipping-deliver").prop("checked",e.shipping.deliver),$("#updateProductBtn").click(function(){let t=$("#updateTitle").val(),s=$("#updatePrice").val(),o=$("#updateCategory").val(),n=$("#updateDescription").val(),a=$("#updateImage").val(),i=$("#updateKeywords").val(),l=$("#updateShipping-pick").is(":checked"),c=$("#updateShipping-deliver").is(":checked"),d=`https://drive.google.com/uc?id=${a}`;a.includes("google")||a.includes("drive")||a.includes("open")?(swal({title:"Wrong image format",text:"Please only enter the image ID NOT the whole link",icon:"warning",button:"Got it",timer:2500}),$("#wrongImageEditAlert").slideDown()):""==t||""==s||""==o||""==n||""==a||""==i||!l&&!c?swal({title:"Fill Out Details",text:"Please enter all details",icon:"warning",button:"Got it",timer:2500}):$.ajax({url:`${url}/updateProduct/p=${e._id}`,type:"PATCH",dataType:"json",data:{title:t,description:n,price:s,image:d,category:o,keywords:i,pickup:l,deliver:c},success:function(t){$("#updateProductModal").modal("hide"),swal({title:"Listing Updated",text:`Successfully updated ${e.title} with new details that you have entered`,icon:"success",button:"Got it",timer:2500}),$.ajax({url:`${url}/products/p=${e._id}`,type:"GET",dataType:"json",success:function(t){r(t)},error:function(t){console.log("failed")}})},error:function(t){alert("Could not update listing")}})})}),$("#deleteProduct").click(function(){swal({title:`Delete ${e.title}`,text:`Are you sure that you want to permentaly remove ${e.title} as a listing. This action cannot be undone!`,icon:"warning",buttons:{cancel:"Cancel",success:{text:"Delete Listing",value:"delete"}}}).then(s=>{switch(s){case"delete":$.ajax({url:`${url}/deleteProduct/p=${e._id}`,type:"DELETE",data:"json",success:function(){swal({title:"Listing Deleted",text:`Successfully deleted ${e.title}`,icon:"success",button:"Got it",timer:2500}),$("#productPage").hide(),n(),t(),$("#productCards").show()},error:function(){alert("Failed to delete listing")}})}})})}(e);else if(sessionStorage.username){document.getElementById("questionForm").innerHTML='<div class="question-form row mx-0 bg-light py-3 col-12 mb-5">\n\t\t\t\t\t<h3>Ask a Question</h3>\n\t\t\t\t\t<textarea class="form-control" id="newQuestion" rows="3"></textarea>\n\t\t\t\t\t<div class="col-12">\n\t\t\t\t\t<button type="button" id="submitQuestionBtn" class="btn btn-primary mt-3 float-right">Ask Question</button>\n\t\t\t\t\t</div></div>',c.watchlist.indexOf(o)>-1?(document.getElementById("dynamicBtnContainer").innerHTML='<div class="col-lg-6 col-md-12">\n\t\t\t\t\t\t<button id="productPurchase" class="btn btn-outline-success btn-block">Buy Now</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="col-lg-6 col-md-12">\n\t\t\t\t\t\t<button id="productRemoveFromWatchList" class="btn btn-outline-danger btn-block watchlist-btn">Remove from watchlist</button>\n\t\t\t\t\t\t</div>',a(e),i(e)):(document.getElementById("dynamicBtnContainer").innerHTML='<div class="col-lg-6 col-md-12">\n\t\t\t\t\t\t<button id="productPurchase" class="btn btn-outline-success btn-block">Buy Now</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="col-lg-6 col-md-12">\n\t\t\t\t\t\t<button id="productAddToWatchList" class="btn btn-outline-primary btn-block watchlist-btn">Add to watchlist</button>\n\t\t\t\t\t\t</div>',a(e),i(e))}else document.getElementById("questionForm").innerHTML='<div class="bg-light p-3">\n\t\t\t\t\t<h4 class="text-dark">Please log in or register to ask a question</h4>\n\t\t\t\t\t</div>',document.getElementById("dynamicBtnContainer").innerHTML='<div class="col-12">\n\t\t\t\t\t<button id="registerAccountProductPageBtn" class="btn btn-outline-primary btn-block">Register an account</button>\n\t\t\t\t\t</div>';$("#submitQuestionBtn").click(function(){let t=$("#newQuestion").val();var s,o;$("#newQuestion").val(""),""!=t&&(s=t,o=e,$.ajax({url:`${url}/addComment`,type:"POST",data:{text:s,userId:sessionStorage.getItem("userID"),productId:o._id,replies:[]},success:function(t){g(o)},error:function(){console.log("error: cannot call api")}}))}),$("#registerAccountProductPageBtn").click(function(){$("#productCards").hide(),$("#productPage").hide(),t(),$("#categories").hide(),$("#searchNav").hide(),$("#registerUsername").val(""),$("#registerFirstName").val(""),$("#registerLastName").val(""),$("#registerLocation").val(""),$("#registerEmail").val(""),$("#registerPassword").val(""),$("#registerForm").show()}),g(e)},error:function(t){alert("Unable to get buyer's details")}})}function d(){$.ajax({url:`${url}/users/u=${sessionStorage.getItem("userID")}`,type:"GET",dataType:"json",success:function(t){$("#profile-username").html(t.username),$("#profile-fullname").html(fullName),$("#profile-location").html(t.location),$("#profile-email").html(t.email),$("#profile-balance").html(`$${t.balance}`)},error:function(){console.log("error: cannot call api")}})}function u(t){$.ajax({url:`${url}/products`,type:"GET",dataType:"json",success:function(e){document.getElementById("myProductCards").innerHTML="";for(let s=0;s<e.length;s++){if("selling"===t&&e[s].sellerId==sessionStorage.getItem("userID")&&"listed"===e[s].status){let t=`<div class="product-link position-rel card p-0 col-lg-3 col-sm-12 col-md-6" id="${e[s]._id}">\n\t\t\t\t\t\t<img class="card-img-top p-4 bg-light" src="${e[s].image}" alt="Image">\n\t\t\t\t\t\t<div class="card-body">\n\t\t\t\t\t\t<h3 class="card-title"> ${e[s].title}</h3>\n\t\t\t\t\t\t<h4 class="card-text">$${e[s].price}</h4>\n\t\t\t\t\t\t</div></div>`;document.getElementById("myProductCards").innerHTML+=t}if("sold"===t&&e[s].sellerId==sessionStorage.getItem("userID")&&"sold"===e[s].status){let t=`<div class="product-link position-relative card p-0 col-lg-3 col-sm-12 col-md-6" id="${e[s]._id}">\n\t\t\t\t\t\t<img class="card-img-top p-4 bg-light" src="${e[s].image}" alt="Image">\n\t\t\t\t\t\t<div class="card-body">\n\t\t\t\t\t\t<h3 class="card-title"> ${e[s].title}</h3>\n\t\t\t\t\t\t<div class="alert alert-danger col-12 text-center" role="alert">Sold</div>\n\t\t\t\t\t\t</div></div>`;document.getElementById("myProductCards").innerHTML+=t}if("bought"===t&&e[s].buyerId==sessionStorage.getItem("userID")&&"sold"===e[s].status){let t=`<div class="product-link position-relative card p-0 col-lg-3 col-sm-12 col-md-6" id="${e[s]._id}">\n\t\t\t\t\t\t<img class="card-img-top p-4 bg-light" src="${e[s].image}" alt="Image">\n\t\t\t\t\t\t<div class="card-body">\n\t\t\t\t\t\t<h3 class="card-title"> ${e[s].title}</h3>\n\t\t\t\t\t\t<div class="alert alert-success col-12 text-center" role="alert">Bought</div>\n\t\t\t\t\t\t</div></div>`;document.getElementById("myProductCards").innerHTML+=t}}l()},error:function(t){console.log("no good")}})}function g(t){$.ajax({url:`${url}/comments`,type:"GET",dataType:"json",success:function(e){document.getElementById("qAndAPrintOut").innerHTML="";for(let s=0;s<e.length;s++)$.ajax({url:`${url}/users/u=${e[s].userId}`,type:"GET",dataType:"json",success:function(o){let n=o.username;if(e[s].productId===t._id){let a=0,i="";if(0==e[s].replies.length?i+=`<div class="col-12 col-md-10 border p-2 pb-5 rounded my-2" id="${e[s]._id}">`:i+=`<div class="col-12 col-md-10 border px-2 pt-2 rounded my-2" id="${e[s]._id}">`,i+=`<p class="mb-0 text-primary font-weight-bold">${n}\n\t\t\t\t\t\t\t\t<span class="text-muted ml-2 font-weight-normal comment-time">${h(e[s])}</span></p>\n\t\t\t\t\t\t\t\t<p class="card-text ml-2">${e[s].text}</p>\n\t\t\t\t\t\t\t\t<div class="comment-replies col-12" id="comment-${e[s]._id}">`,!e[s].replies.includes(null))for(let n=0;n<e[s].replies.length;n++)$.ajax({url:`${url}/users/u=${e[s].replies[n].userId}`,type:"GET",dataType:"json",success:function(i){let r=i.username,l='<div class="col-11 border p-2 rounded mb-2 float-right">';o.username===r&&(l+=`<p class="mb-0 text-primary font-weight-bold">${r}<span class="text-muted ml-2 font-weight-normal comment-time">${h(e[s].replies[n])}</span></p>`),i._id===t.sellerId&&(l+=`<p class="mb-0 text-success font-weight-bold">${r}<span class="text-muted ml-2 font-weight-normal comment-time">${h(e[s].replies[n])}</span></p>`),i._id!=t.sellerId&&o.username!=r&&(l+=`<p class="mb-0 text-dark font-weight-bold">${r}<span class="text-muted ml-2 font-weight-normal comment-time">${h(e[s].replies[n])}</span></p>`),l+=`<p class="card-text ml-2">${e[s].replies[n].text}</p></div>`,a++,$("#"+e[s]._id).css("padding-bottom",m(a));let c=`comment-${e[s]._id}`;document.getElementById(c).innerHTML+=l},error:function(t){console.log("no good")}});i+='</div><div class="col-12 form-inline float-right">',sessionStorage.getItem("username")&&"listed"==t.status&&(i+='<input type="text" class="form-control reply-input col-8 col-md-9" name="reply-input" placeholder="Reply">\n\t\t\t\t\t\t\t\t\t<button type="button" class="btn btn-primary col-4 col-md-3 replyBtn">Reply</button>'),i+="</div></div>",document.getElementById("qAndAPrintOut").innerHTML+=i,$(".replyBtn").click(function(e){p(e,t)})}},error:function(t){console.log("no good")}})},error:function(t){console.log("no good")}})}function m(t){let e=4.6*t+3;return e+="rem"}function p(t,e){let s=t.target.parentNode.parentNode.attributes[1].value,o=t.target.previousElementSibling.value;""!=o&&$.ajax({url:`${url}/commentReply/c=${s}`,type:"PATCH",data:{text:o,time:new Date,userId:sessionStorage.getItem("userID")},success:function(t){g(e)},error:function(){console.log("error: cannot call api")}})}function h(t){let e=t.time,s=new Date(Date.parse(e));let o=s.getDate(),n=s.getMonth()+1,a=s.getFullYear(),i=s.getHours(),r=s.getMinutes();const l=new Date,c=new Date(l-864e5),d=Math.round((l-s)/1e3),u=Math.round(d/60),g=l.toDateString()===s.toDateString(),m=c.toDateString()===s.toDateString();return r<10&&(r=`0${r}`),d<10?"Just now":d<60?`${d} seconds ago`:d<100?"About a minute ago":u<60?`${u} minutes ago`:g?`Today at ${i}:${r}`:m?`Yesterday at ${i}:${r}`:`${o}/${n}/${a} ${i}:${r}`}$("#navLoggedIn").hide(),$("#registerForm").hide(),$("#account").hide(),$("#productCards").show(),$("#productPage").hide(),sessionStorage.username?($("#navLoggedIn").show(),$("#navLoggedOut").hide(),fullName=sessionStorage.getItem("userFName")+" "+sessionStorage.getItem("userLName"),document.getElementById("firstNameGreeting").innerHTML=sessionStorage.getItem("userFName")):($("#navLoggedIn").hide(),$("#navLoggedOut").show()),$(".navbar-brand").click(function(){t(),$("#account").hide(),$("#registerForm").hide(),n(),$("#productCards").show(),$("#productPage").hide(),$("#filterBar").show()}),$.ajax({url:"config.json",type:"GET",dataType:"json",success:function(t){url=`${t.SERVER_URL}:${t.SERVER_PORT}`,n()},error:function(){console.log("error: cannot call api")}}),$("#searchButton").click(function(s){s.preventDefault(),$.ajax({url:`${url}/products`,type:"GET",dataType:"json",success:function(s){document.getElementById("productCards").innerHTML=" ";let o=$("#searchBar").val().toLowerCase();for(var n=0;n<s.length;n++){let t=s[n].title.toLowerCase(),e=s[n].keywords.toLowerCase();if("listed"==s[n].status&&(t.includes(o)||e.includes(o))){let t=`<div class="product-link position-relative card p-0 col-lg-3 col-sm-12 col-md-6" id="${s[n]._id}">\n\t\t\t\t\t\t<img class="card-img-top p-4 bg-light" src="${s[n].image}" alt="Image">`;sessionStorage.username&&(t+='<div class="btn-watchlist-card" title="Add to watchlist">+</div>'),t+=`<div class="card-body">\n\t\t\t\t\t\t<h3 class="card-title"> ${s[n].title}</h3>\n\t\t\t\t\t\t<h4 class="card-text">$${s[n].price}</h4>\n\t\t\t\t\t\t</div></div>`,document.getElementById("productCards").innerHTML+=t}}l(),t(),e(),$("#account").hide(),$("#productCards").show(),$("#productPage").hide(),$("#filterBar").show()},error:function(){console.log("cannot complete search")}})}),$(".btn-category").click(function(){let t=$(this).attr("id").slice(0,-6);$(this).attr("id");$("#account").hide(),$("#registerForm").hide(),$("#productCards").show(),$("#filterBar").show(),$("#productPage").hide(),$(this).removeClass("btn-outline-secondary").addClass("btn-secondary").siblings().removeClass("btn-secondary").addClass("btn-outline-secondary"),$.ajax({url:`${url}/products`,type:"GET",dataType:"json",success:function(s){var n=[];if(document.getElementById("productCards").innerHTML=" ",sessionStorage.getItem("userID"))$.ajax({url:`${url}/users/u=${sessionStorage.getItem("userID")}`,type:"GET",dataType:"json",success:function(a){n=a.watchlist;var i=!1;t:for(var r=0;r<s.length;r++){if(s[r].category.toLowerCase().includes(t)&"listed"==s[r].status){let t=`<div class="product-link position-relative card p-0 col-lg-3 col-sm-12 col-md-6" id="${s[r]._id}">\n\t\t\t\t\t\t\t\t\t<img class="card-img-top p-4 bg-light" src="${s[r].image}" alt="Image">`;if(sessionStorage.username&&sessionStorage.getItem("userID")!=s[r].sellerId){for(let e=0;e<n.length;e++){if(n[e]==s[r]._id){t+=`<div class="btn-watchlist-card" title="Remove from watchlist">-</div>\n\t\t\t\t\t\t\t\t\t\t\t\t<div class="card-body">\n\t\t\t\t\t\t\t\t\t\t\t\t<h3 class="card-title"> ${s[r].title}</h3>\n\t\t\t\t\t\t\t\t\t\t\t\t<h4 class="card-text">$${s[r].price}</h4>\n\t\t\t\t\t\t\t\t\t\t\t\t</div></div>`,document.getElementById("productCards").innerHTML+=t;continue t}i=!0}(i||0===n.length)&&(t+='<div class="btn-watchlist-card" title="Add to watchlist">+</div>')}t+=`<div class="card-body">\n\t\t\t\t\t\t\t\t\t<h3 class="card-title"> ${s[r].title}</h3>\n\t\t\t\t\t\t\t\t\t<h4 class="card-text">$${s[r].price}</h4>\n\t\t\t\t\t\t\t\t\t</div></div>`,document.getElementById("productCards").innerHTML+=t}}l(),o(),e()},error:function(t){console.log("Couldnt load watchlist while sorting")}});else{for(var a=0;a<s.length;a++){if(s[a].category.toLowerCase().includes(t)&"listed"==s[a].status){let t=`<div class="product-link position-relative card p-0 col-lg-3 col-sm-12 col-md-6" id="${s[a]._id}">\n\t\t\t\t\t\t\t<img class="card-img-top p-4 bg-light" src="${s[a].image}" alt="Image">`;t+=`<div class="card-body">\n\t\t\t\t\t\t\t<h3 class="card-title"> ${s[a].title}</h3>\n\t\t\t\t\t\t\t<h4 class="card-text">$${s[a].price}</h4>\n\t\t\t\t\t\t\t</div></div>`,document.getElementById("productCards").innerHTML+=t}}l()}},error:function(){console.log("cannot get category")}})}),$("#filterSelect").on("change",function(){t(),"low"==$(this).val()?$.ajax({url:`${url}/products`,type:"GET",dataType:"json",success:function(t){t.sort(function(t,e){return t.price-e.price}),s(t)},error:function(){console.log("cannot filter objects")}}):"high"==$(this).val()?$.ajax({url:`${url}/products`,type:"GET",dataType:"json",success:function(t){t.sort(function(t,e){return e.price-t.price}),s(t)},error:function(){console.log("cannot filter objects")}}):"featured"===$(this).val()&&$.ajax({url:`${url}/products`,type:"GET",dataType:"json",success:function(t){s(t)},error:function(){console.log("cannot filter objects")}})}),$("#loginButton").click(function(){let t=$("#loginUsername").val(),e=$("#loginPassword").val();""==t||""==e?swal({title:"Enter username and password",text:"Please fill all fields details",icon:"warning",button:"Got it",timer:2500}):$.ajax({url:`${url}/login`,type:"POST",data:{username:t,password:e},success:function(t){"User not found"==t?(swal({title:"Not a user",text:"There is no account for this username. Please try again or register",icon:"warning",button:"Got it",timer:2500}),$("#loginUsername").val(""),$("#loginUsername").focus(),$("#loginPassword").val("")):"Not authorised. Incorrect password"==t?(swal({title:"Incorrect password",text:"Password incorrect. Please try again",icon:"warning",button:"Got it",timer:2500}),$("#loginPassword").val(""),$("#loginPassword").focus()):(sessionStorage.setItem("userID",t._id),sessionStorage.setItem("username",t.username),sessionStorage.setItem("userFName",t.firstName),sessionStorage.setItem("userLName",t.lastName),sessionStorage.setItem("userEmail",t.email),fullName=sessionStorage.getItem("userFName")+" "+sessionStorage.getItem("userLName"),document.getElementById("firstNameGreeting").innerHTML=sessionStorage.getItem("userFName"),$("#navLoggedIn").show(),$("#navLoggedOut").hide(),$("#registerForm").hide(),$("#productPage").hide(),$("#productCards").show(),$("#filterContainer").show(),l(),n())},error:function(){console.log("error: cannot call api")}})}),$("#logoutButton").click(function(){sessionStorage.clear(),t(),n(),$("#filterBar").show(),$("#navLoggedIn").hide(),$("#navLoggedOut").show(),$("#account").hide(),$("#loginUsername").val(""),$("#loginPassword").val(""),$("#productPage").hide(),$("#productCards").show()}),$("#registerButton").click(function(){t(),$("#productCards").hide(),$("#productPage").hide(),$("#filterContainer").hide(),$("#registerUsername").val(""),$("#registerFirstName").val(""),$("#registerLastName").val(""),$("#registerLocation").val(""),$("#registerEmail").val(""),$("#registerPassword").val(""),$("#registerForm").show()}),$("#registerUser").click(function(){let t=$("#registerUsername").val(),e=$("#registerFirstName").val(),s=$("#registerLastName").val(),o=$("#registerLocation").val(),a=$("#registerEmail").val(),i=$("#registerPassword").val();if(""==t||""==e||""==s||""==o||""==a||""==i)swal({title:"Fill Out Details",text:"Please enter all details",icon:"warning",button:"Got it",timer:2500});else{let r=[];$.ajax({url:`${url}/register`,type:"POST",data:{username:t,firstName:e,lastName:s,email:a,password:i,watchlist:r,balance:100,location:o},success:function(t){"This username is already taken. Please try another one"===t?swal({title:"Username already taken",text:"There is already an account with this username. Please login or try again",icon:"warning",button:"Got it",timer:2500}):($("#registerForm").hide(),$("#loginUsername").focus(),$("#productCards").show(),$("#filterContainer").show(),n(),swal({title:"Success!",text:"Congratulations! Your new account has been registered\n Please log in to continue",icon:"success",button:"Okay!",timer:2500}))},error:function(){console.log("error: cannot call api")}})}}),$("#addListingBtn").click(function(){$("#wrongImageAlert").hide(),$("#addTitle").val(""),$("#addPrice").val(""),$("#addCategory").val(""),$("#addDescription").val(""),$("#addImage").val(""),$("#addKeywords").val(""),$("#shipping-pick").prop("checked",!1),$("#shipping-deliver").prop("checked",!1),$("#addTitle").focus()}),$("#addProductBtn").click(function(){let t=$("#addTitle").val(),e=parseInt($("#addPrice").val()),s=$("#addCategory").val(),o=$("#addDescription").val(),a=$("#addImage").val(),i=$("#addKeywords").val(),r=$("#shipping-pick").is(":checked"),l=$("#shipping-deliver").is(":checked"),c=sessionStorage.getItem("userID"),d=`https://drive.google.com/uc?id=${a}`;a.includes("google")||a.includes("drive")||a.includes("open")?(swal({title:"Wrong image format",text:"Please only enter the image ID NOT the whole link",icon:"warning",button:"Got it",timer:2500}),$("#wrongImageAlert").slideDown()):""==t||""==e||""==s||""==o||""==a||""==i||!r&&!l?swal({title:"Fill Out Details",text:"Please enter all details",icon:"warning",button:"Got it",timer:2500}):$.ajax({url:`${url}/addProduct`,type:"POST",data:{title:t,description:o,price:e,image:d,status:"listed",keywords:i,sellerId:c,buyerId:c,category:s,pickup:r,deliver:l},success:function(t){u("selling"),$("#addProductModal").modal("hide"),swal({title:"Success!",text:"Congratulations! Your product has been listed",icon:"success",button:"Okay!",timer:2500}),n()},error:function(){console.log("error: cannot call api")}})}),$("#myAccountButton").click(function(){d(),u("selling");let e=document.querySelectorAll(".account-info__sidebar__list-item");for(var s=0;s<e.length;s++)e[s].classList.remove("account-info__sidebar__list-item--active");e[0].classList.add("account-info__sidebar__list-item--active"),t(),$("#productCards").hide(),$("#productPage").hide(),$("#account").show(),$("#filterBar").hide()}),$("#viewSelling").click(function(){u("selling"),document.getElementById("myProductCards").scrollIntoView()}),$("#viewSold").click(function(){u("sold"),document.getElementById("myProductCards").scrollIntoView()}),$("#viewBought").click(function(){u("bought"),document.getElementById("myProductCards").scrollIntoView()}),$("#viewWatchlist").click(function(){$.ajax({url:`${url}/users/u=${sessionStorage.getItem("userID")}`,type:"GET",dataType:"json",success:function(t){document.getElementById("myProductCards").innerHTML="",0==t.watchlist.length?document.getElementById("myProductCards").innerHTML='You have no products added to your watchlist. Click the plus icon in the corner of a product to add it to your watchlist or go to the product\'s page and click "add to watchlist"':$.ajax({url:`${url}/products`,type:"GET",dataType:"json",success:function(e){document.getElementById("myProductCards").innerHTML="";for(let s=0;s<t.watchlist.length;s++)for(let o=0;o<e.length;o++)if(e[o]._id==t.watchlist[s]&&"listed"===e[o].status){let t=`<div class="product-link position-relative card p-0 col-lg-3 col-sm-12 col-md-6" id="${e[o]._id}">\n\t\t\t\t\t\t\t\t\t\t<img class="card-img-top p-4 bg-light" src="${e[o].image}" alt="Image">\n\t\t\t\t\t\t\t\t\t\t<div class="card-body">\n\t\t\t\t\t\t\t\t\t\t<h3 class="card-title"> ${e[o].title}</h3>\n\t\t\t\t\t\t\t\t\t\t<h4 class="card-text">$${e[o].price}</h4>\n\t\t\t\t\t\t\t\t\t\t</div></div>`;document.getElementById("myProductCards").innerHTML+=t}l()},error:function(t){console.log("no good")}}),l()},error:function(t){console.log("no good")}}),document.getElementById("myProductCards").scrollIntoView()}),$("#editProfileBtn").click(function(){$.ajax({url:`${url}/users/u=${sessionStorage.getItem("userID")}`,type:"GET",dataType:"json",success:function(t){$("#editFirstName").val(t.firstName),$("#editLastName").val(t.lastName),$("#editLocation").val(t.location),$("#editEmail").val(t.email)},error:function(){console.log("error: cannot call api")}})}),$("#saveProfileBtn").click(function(){let t=$("#editFirstName").val(),e=$("#editLastName").val(),s=$("#editLocation").val(),o=$("#editEmail").val();$.ajax({url:`${url}/updateUser/u=${sessionStorage.getItem("userID")}`,type:"PATCH",data:{firstName:t,lastName:e,email:o,location:s},success:function(s){$("#editProfileModal").modal("hide"),swal({title:"Success!",text:"Your profile details have been updated",icon:"success",button:"Confirm"}),sessionStorage.setItem("userFName",t),sessionStorage.setItem("userLName",e),sessionStorage.setItem("userEmail",o),fullName=sessionStorage.getItem("userFName")+" "+sessionStorage.getItem("userLName"),d()},error:function(){console.log("error: cannot call api")}})}),$("#deleteAccountButton").click(function(){$("#editProfileModal").modal("hide"),swal({title:"Are you sure you want to delete your profile?",text:"This action cannot be undone!",icon:"warning",buttons:{cancel:"Cancel",success:{text:"Delete Profile",value:"delete"}}}).then(t=>{switch(t){case"delete":$.ajax({url:`${url}/deleteUser/u=${sessionStorage.getItem("userID")}`,type:"DELETE",data:"json",success:function(t){swal({title:"Your profile has been deleted",text:"Successfully deleted",icon:"success",button:"Got it"}),$.ajax({url:`${url}/products/`,type:"GET",data:"json",success:function(t){for(let e=0;e<t.length;e++)t[e].sellerId==sessionStorage.getItem("userID")&&$.ajax({url:`${url}/deleteProduct/p=${t[e]._id}`,type:"DELETE",data:"json",success:function(){console.log("delete the thing")},error:function(){alert("Failed to delete products")}});sessionStorage.clear(),setTimeout(location.reload.bind(location),500),$("#productPage").hide(),n(),$("#productCards").show()},error:function(){alert("Failed to delete products")}})},error:function(){alert("Failed to delete user")}})}})}),$(".account-info__sidebar__list-item").click(function(){let t=document.querySelectorAll(".account-info__sidebar__list-item");for(var e=0;e<t.length;e++)t[e].classList.remove("account-info__sidebar__list-item--active");$(this).addClass("account-info__sidebar__list-item--active")})});